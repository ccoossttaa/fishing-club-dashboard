<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Island Fishing Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .live-dot {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .sidebar-handle {
            position: absolute;
            top: 50%;
            left: 0;
            width: 12px;
            height: 80px;
            background-color: #0ea5e9;
            cursor: pointer;
            z-index: 1001;
            transform: translateY(-50%);
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            overflow: hidden;
        }
        .sidebar-handle::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: glimmer 2.5s infinite;
        }
        @keyframes glimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        .modal, #mobile-controls-sheet {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #map {
            height: 100%;
        }
        .gm-style-iw-c {
            padding: 8px !important;
            border-radius: 8px !important;
        }
        .gm-style-iw-d {
            overflow: hidden !important;
        }
        .info-window-content {
            color: #000;
            font-weight: 600;
            text-align: center;
        }
        #wind-arrow {
            transition: transform 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col h-screen overflow-hidden">

    <!-- Top Navigation Bar -->
    <nav class="bg-gray-800/50 backdrop-blur-sm shadow-lg w-full fixed top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-anchor text-sky-400 text-2xl"></i>
                    <span class="ml-3 text-xl font-bold text-white">LI Fishing Club</span>
                </div>
                <!-- Desktop Nav -->
                <div class="hidden md:block">
                    <div id="main-nav" class="ml-10 flex items-baseline space-x-4">
                        <a href="#" data-target="dashboard-page" class="nav-link bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="#" data-target="catch-log-page" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Catch Log</a>
                        <a href="#" data-target="gallery-page" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Gallery</a>
                    </div>
                </div>
                <!-- Mobile Nav Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Nav Menu -->
        <div id="mobile-menu" class="md:hidden hidden bg-gray-800/90">
            <a href="#" data-target="dashboard-page" class="nav-link block text-white px-4 py-2 text-sm">Dashboard</a>
            <a href="#" data-target="catch-log-page" class="nav-link block text-gray-300 hover:bg-gray-700 px-4 py-2 text-sm">Catch Log</a>
            <a href="#" data-target="gallery-page" class="nav-link block text-gray-300 hover:bg-gray-700 px-4 py-2 text-sm">Gallery</a>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="app-content" class="flex-grow pt-16 h-full">
        <!-- Dashboard Page -->
        <main id="dashboard-page" class="page-content flex h-full">
            <!-- Desktop Sidebar -->
            <div id="sidebar" class="hidden md:flex bg-gray-800/70 backdrop-blur-md h-full transition-all duration-300 ease-in-out flex-col" style="width: 320px;">
                <div class="p-4 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Dashboard Controls</h2>
                        <button id="collapse-btn" class="p-2 rounded-md hover:bg-gray-700">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div class="overflow-y-auto">
                        <!-- Live Conditions, Moon, Intel Button, Spots List -->
                        <div class="bg-gray-900/50 p-4 rounded-lg text-center mb-4">
                            <div class="flex items-center justify-center mb-2"><h3 class="text-md font-semibold mr-2">Live Conditions</h3><div class="live-dot"></div></div>
                            <div id="live-conditions-data" class="grid grid-cols-3 gap-2 text-lg">
                                <div><div class="font-bold" id="temp-data">--Â°</div><div class="text-xs text-gray-400">Temp</div></div>
                                <div><div class="font-bold" id="wind-data">--</div><div class="text-xs text-gray-400">Wind</div></div>
                                <div class="flex flex-col items-center"><div class="font-bold flex items-center"><span id="dir-data">--</span><i id="wind-arrow" class="fas fa-arrow-up ml-1 text-sm"></i></div><div class="text-xs text-gray-400">Direction</div></div>
                            </div>
                            <div id="selected-spot-name" class="mt-3 text-sm text-sky-400 font-medium h-5">Select a spot</div>
                        </div>
                        <div class="bg-gray-900/50 p-4 rounded-lg text-center mb-4">
                             <h3 class="text-md font-semibold mb-2">Moon Phase</h3>
                             <div class="flex items-center justify-center"><div id="moon-icon-container" class="w-12 h-12 mr-4"></div><span id="moon-phase-name" class="font-semibold text-lg">--</span></div>
                        </div>
                        <button id="intel-btn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Get Spot Intel</button>
                        <div class="mt-4"><details open><summary class="font-semibold cursor-pointer py-2">Fishing Spots</summary><div class="mt-2"><input type="text" id="spot-search" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Search spots..."><ul id="spots-list" class="mt-2 space-y-1 pr-2 overflow-y-auto" style="max-height: calc(100vh - 550px);"></ul></div></details></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Handle -->
            <div id="sidebar-handle" class="sidebar-handle hidden"></div>

            <!-- Interactive Map -->
            <div id="map" class="flex-grow h-full z-10"></div>
        </main>

        <!-- Catch Log Page -->
        <div id="catch-log-page" class="page-content hidden h-full p-8">
            <h1 class="text-3xl font-bold text-white">Catch Log</h1>
            <p class="mt-4 text-gray-400">This section is under construction. Soon you'll be able to log your catches here!</p>
        </div>

        <!-- Gallery Page -->
        <div id="gallery-page" class="page-content hidden h-full p-8">
            <h1 class="text-3xl font-bold text-white">Gallery</h1>
            <p class="mt-4 text-gray-400">This section is under construction. Soon you'll be able to view a gallery of catches here!</p>
        </div>
    </div>

    <!-- Mobile Controls Button -->
    <div id="mobile-controls-trigger" class="md:hidden fixed bottom-4 right-4 z-30">
        <button class="bg-sky-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
            <i class="fas fa-sliders-h text-2xl"></i>
        </button>
    </div>

    <!-- Mobile Controls Bottom Sheet -->
    <div id="mobile-controls-sheet" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40 transform translate-y-full">
        <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-2xl p-4 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-4 cursor-pointer" id="mobile-sheet-handle"></div>
            <div class="overflow-y-auto">
                <!-- Widgets will be cloned here -->
            </div>
        </div>
    </div>

    <!-- AI Intel Modal -->
    <div id="intel-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold text-white">Spot Intel</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div>
                    <h4 class="font-semibold text-sky-400 mb-2 flex items-center"><i class="fas fa-brain mr-2"></i>AI Fishing Intel</h4>
                    <div id="ai-intel-content" class="bg-gray-900/50 p-4 rounded-lg min-h-[150px] text-gray-300 whitespace-pre-wrap">
                        <div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin text-2xl"></i><span class="ml-3">Generating expert advice...</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const GOOGLE_MAPS_API_KEY = "AIzaSyCCQ60HKzXRSmsSSNy-B9XOE4arwvGTMgI";
        const spotsDataCSV = `name,lat,lon
Old Inlet,40.7238088,-72.8974523
...`; // CSV data remains the same

        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const collapseBtn = document.getElementById('collapse-btn');
        const sidebarHandle = document.getElementById('sidebar-handle');
        const intelBtn = document.getElementById('intel-btn');
        const intelModal = document.getElementById('intel-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const aiIntelContent = document.getElementById('ai-intel-content');
        const modalTitle = document.getElementById('modal-title');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileControlsTrigger = document.getElementById('mobile-controls-trigger');
        const mobileControlsSheet = document.getElementById('mobile-controls-sheet');
        const mobileSheetHandle = document.getElementById('mobile-sheet-handle');

        // --- State ---
        let map;
        let spots = [];
        let markers = {};
        let selectedSpot = null;
        let infoWindow;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            cloneWidgetsForMobile();
            updateMoonPhase();
            setupNavigation();
            setupMobileControls();
        });

        function cloneWidgetsForMobile() {
            const desktopWidgets = sidebar.querySelector('.overflow-y-auto');
            const mobileContainer = mobileControlsSheet.querySelector('.overflow-y-auto');
            mobileContainer.innerHTML = desktopWidgets.innerHTML;
            // Re-bind events for cloned elements
            mobileContainer.querySelector('#spot-search').addEventListener('input', (e) => renderSpotsList(e.target.value, '#mobile-controls-sheet'));
            mobileContainer.querySelector('#intel-btn').addEventListener('click', openIntelModal);
        }

        function initMap() {
            const mapStyle = [/* Map style array remains the same */];
            map = new google.maps.Map(document.getElementById("map"), { center: { lat: 40.85, lng: -72.9 }, zoom: 9, styles: mapStyle, disableDefaultUI: true, zoomControl: true, mapTypeControl: false, streetViewControl: false, fullscreenControl: false });
            infoWindow = new google.maps.InfoWindow({ maxWidth: 200 });
            parseCSV();
            renderSpotsList('#sidebar');
            renderSpotsList('#mobile-controls-sheet');
            setupEventListeners();
        }

        function parseCSV() {
            const rows = spotsDataCSV.trim().split('\n');
            const headers = rows.shift().split(',');
            spots = rows.map(row => { const values = row.split(','); return headers.reduce((obj, header, i) => { obj[header] = values[i]; return obj; }, {}); });
        }
        
        function renderSpotsList(containerSelector, filter = '') {
            const container = document.querySelector(containerSelector);
            const spotsList = container.querySelector('#spots-list');
            spotsList.innerHTML = '';
            
            // Clear markers only once
            if (containerSelector === '#sidebar') {
                Object.values(markers).forEach(marker => marker.setMap(null));
                markers = {};
            }

            const filteredSpots = spots.filter(spot => spot.name.toLowerCase().includes(filter.toLowerCase()));
            if (filteredSpots.length === 0) {
                spotsList.innerHTML = `<li class="text-gray-400 text-sm p-2">No spots found.</li>`;
            } else {
                filteredSpots.forEach(spot => {
                    const lat = parseFloat(spot.lat);
                    const lon = parseFloat(spot.lon);
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded-md hover:bg-sky-800/50 cursor-pointer text-sm';
                    li.textContent = spot.name;
                    li.addEventListener('click', () => {
                        handleSpotSelection(spot);
                        closeMobileControls();
                    });
                    spotsList.appendChild(li);

                    if (containerSelector === '#sidebar') {
                        const marker = new google.maps.Marker({ position: { lat: lat, lng: lon }, map: map, title: spot.name, opacity: 0.7 });
                        marker.addListener('click', () => handleSpotSelection(spot));
                        markers[spot.name] = marker;
                    }
                });
            }
        }

        function setupEventListeners() {
            collapseBtn.addEventListener('click', toggleSidebar);
            sidebarHandle.addEventListener('click', toggleSidebar);
            document.querySelector('#sidebar #spot-search').addEventListener('input', (e) => renderSpotsList('#sidebar', e.target.value));
            document.querySelector('#sidebar #intel-btn').addEventListener('click', openIntelModal);
            closeModalBtn.addEventListener('click', closeIntelModal);
            intelModal.addEventListener('click', (e) => { if (e.target === intelModal) closeIntelModal(); });
        }

        function setupNavigation() {
            const allNavLinks = document.querySelectorAll('.nav-link');
            allNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.target;
                    
                    pages.forEach(page => page.classList.add('hidden'));
                    document.getElementById(pageId).classList.remove('hidden');

                    navLinks.forEach(navLink => {
                        navLink.classList.remove('bg-gray-900', 'text-white');
                        navLink.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                    });
                    document.querySelectorAll(`[data-target="${pageId}"]`).forEach(activeLink => {
                        activeLink.classList.add('bg-gray-900', 'text-white');
                        activeLink.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                    });
                    mobileMenu.classList.add('hidden');
                });
            });

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        function setupMobileControls() {
            mobileControlsTrigger.addEventListener('click', openMobileControls);
            mobileSheetHandle.addEventListener('click', closeMobileControls);
            mobileControlsSheet.addEventListener('click', (e) => {
                if(e.target === mobileControlsSheet) closeMobileControls();
            });
        }

        function openMobileControls() {
            mobileControlsSheet.classList.remove('translate-y-full');
        }

        function closeMobileControls() {
            mobileControlsSheet.classList.add('translate-y-full');
        }

        function toggleSidebar() {
            const isCollapsed = sidebar.style.width === '0px';
            sidebar.style.width = isCollapsed ? '320px' : '0px';
            sidebarHandle.classList.toggle('hidden', isCollapsed);
            setTimeout(() => { google.maps.event.trigger(map, 'resize'); }, 300);
        }

        async function handleSpotSelection(spot) {
            selectedSpot = spot;
            const lat = parseFloat(spot.lat);
            const lon = parseFloat(spot.lon);
            map.panTo({ lat, lng: lon });
            if (map.getZoom() < 13) { map.setZoom(13); }
            Object.values(markers).forEach(m => m.setOpacity(0.6));
            markers[spot.name].setOpacity(1.0);
            const contentString = `<div class="info-window-content">${spot.name}</div>`;
            infoWindow.setContent(contentString);
            infoWindow.open(map, markers[spot.name]);
            
            updateAllWidgets('selectedSpotName', spot.name);
            updateAllWidgets('intelBtn', btn => btn.disabled = false);

            updateAllWidgets('tempData', el => el.textContent = '...');
            updateAllWidgets('windData', el => el.textContent = '...');
            updateAllWidgets('dirData', el => el.textContent = '...');
            
            await fetchWeather(lat, lon);
        }
        
        function updateAllWidgets(elementId, updateFn) {
            document.querySelectorAll(`#${elementId}`).forEach(el => {
                if (typeof updateFn === 'function') {
                    updateFn(el);
                } else {
                    el.textContent = updateFn;
                }
            });
        }

        async function fetchWeather(lat, lon) {
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Weather data not available');
                const data = await response.json();
                const current = data.current;
                
                updateAllWidgets('tempData', `${Math.round(current.temperature_2m)}Â°`);
                updateAllWidgets('windData', `${Math.round(current.wind_speed_10m)}mph`);
                updateAllWidgets('dirData', degreesToCardinal(current.wind_direction_10m));
                updateAllWidgets('windArrow', el => el.style.transform = `rotate(${current.wind_direction_10m}deg)`);

            } catch (error) {
                console.error("Error fetching weather:", error);
                updateAllWidgets('tempData', 'N/A');
                updateAllWidgets('windData', 'N/A');
                updateAllWidgets('dirData', 'N/A');
                updateAllWidgets('selectedSpotName', "Weather data unavailable");
            }
        }

        // --- Moon Phase Calculation and Display ---
        function getMoonPhase() { /* Remains the same */ }
        function updateMoonPhase() {
            const phaseInfo = getMoonPhase();
            updateAllWidgets('moonPhaseName', phaseInfo.name);
            updateAllWidgets('moonIconContainer', el => el.innerHTML = createMoonSVG(phaseInfo.phase));
        }
        function createMoonSVG(phase) { /* Remains the same */ }
        function openIntelModal() { /* Remains the same */ }
        function closeIntelModal() { /* Remains the same */ }
        async function fetchAIIntel() { /* Remains the same */ }
        async function callGeminiAPI(prompt) { /* Remains the same */ }
        function degreesToCardinal(deg) { /* Remains the same */ }

        // Dynamically load the Google Maps script
        const script = document.createElement('script');
        script.async = true;
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
        document.head.appendChild(script);

    </script>
</body>
</html>
